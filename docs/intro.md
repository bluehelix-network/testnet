# Getting Start with Bluehelix Chain Testnet

*Read this in other languages: English, 简体中文(TBD).*

As the testnet is under active development, we currently provide the components pre-built as docker images for best compatibility, uploaded at:
- Node service: https://hub.docker.com/r/bluehelixnetwork/testnet
- Chainnode service: https://hub.docker.com/r/bluehelixnetwork/testnet-chainnode

## Setup and run a node

As the components are built as docker images, we need docker installed as a pre-requisite.

The setup is through the [docker-compose.yml](../docker-compose.yml) provided in the repository. The steps are as follows:

1. Clone the repository.

```console
$ git clone https://github.com/bluehelix-network/testnet.git
```

2. In the repository directory, start the node service (called bhclear) using docker-compose.

```console
$ docker-compose up -d bhclear
```

3. Check the node log and wait for block synchronization, which may take a while.

```console
$ docker-compose logs -f bhclear
```

## Interact with the chain

Once the node is started and fully synced with all blocks, we can use cli tool to interact with the chain. The cli tool is also run through docker-compose, and all commands can be found through the following command.

```console
$ docker-compose run bhcli help
```

**Note:** You can add ```--node``` argument in entrypoint section variable in [docker-compose.yml](docker-compose.yml) supplies the url for cli tool to connect to. The default is set to the local node's IP address and RPC port (localhost:26657).

Here we present instructions to deposit, transfer and withdraw cross-chain assets, i.e., ETH from [Ethereum Ropsten TestNet](https://ropsten.etherscan.io/).

*Important notice: Bluehelix Chain testnet currently **ONLY** supports ETH on Ethereum Ropsten Testnet. Any other assets including mainnet ETH should not be used at this time, and will be lost.*

### 1. Create and manage Bluehelix Chain custodian unit.

A custodian unit is the account on Bluehelix Chain that can hold cross-chain assets, as a custodian unit. We will use custodian unit for account concept through out the docs.

```console
$ docker-compose run bhcli keys add alice
Enter a passphrase to encrypt your key to disk:
Repeat the passphrase:
NAME:	TYPE:	ADDRESS:				PUBKEY:
alice	local	cosmos1j52w984y2454lsllk3g9s90hud9gn8crlur5cp	cosmospub1addwnpepqvu7jx79skgyr9ma4zgtdwhd8sklau646sqsruekf7l2fug0eqs0zaagmrp
```

Please ignore the output address and pubkey as we are using cosmos-sdk to manage keystore. Insterad, we can run following command to get Bluehelix Chain custodian unit address:

```console
$ docker-compose run bhcli cu show -a alice
BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL
```

The output example shows that a new custodian unit with address ```BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL``` is created. The address in Bluehelix Chain is always starting with `BH`.

Then we can query the initial asset information of the custodian unit from the node:

```console
$ docker-compose run bhcli query assets BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL --chain-id bhchain-testnet

  CUAddress:BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL
  Symbol:BHT
  Address:
  Balance:0
  BalanceOnhold:0
  AssetType:2

```

**Note:** The chain id is ```bhchain-testnet``` whenever ```--chain-id`` argument is required.

There is only 0 balance of BHT for this custodian unit address. After requesting some BHT, for example, 500 BHT, running the same query will give:

```console
$ docker-compose run bhcli query assets BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL --chain-id bhchain-testnet

  CUAddress:BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL
  Symbol:BHT
  Address:
  Balance:500000000000000000000
  BalanceOnhold:0
  AssetType:2

```
Note that BHT has 18 decimals.

### 2. Create a custodian deposit address for Ropsten testnet ETH

To manage cross-chain assets, the first task is to create a custodian deposit address. This is through the ```token``` sub tx command in the cli tool.

```console
$ docker-compose run bhcli --chain-id bhchain-testnet tx cu keygen BHETH BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL --from alice --gas-prices 1ubht
{"chain_id":"bhchain-testnet","account_number":"0","sequence":"0","fee":{"amount":[{"denom":"bht","amount":"200000000000000000"}],"gas":"200000"},"msgs":[{"type":" custodianunit/MsgKeyGen","value":{"Symbol":"BHETH","To":"BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL","From":"BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL"}}],"memo":""}

confirm transaction before signing and broadcasting [Y/n]: Y
Password to sign with 'alice':

Response:
  TxHash: F5AF1EE4E3394FE40BA176A236BBF091BBF992EAFE9012CF4979F6E13E23E0EA
```

**Note:** The gas price on testnet can be always set to ```1ubht```.

The deposit address is generated by all validators asynchronously. After the deposit address is generated, the validators will broadcast a MsgKeyGenFinish transaction to Bluehelix Chain. After a while when the MsgKeyGenFinish transaction is committed, we can query result in two ways:

```console
$ docker-compose run bhcli query cu order BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL 0 --chain-id bhchain-testnet

		CUAddress:BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL
		ID:0
		OrderType:1
		Symbol:BHETH
		Status:7
		To:BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL
		MultiSignAddress:0x2a061581Ae905F5223E21028C9b738759fa721db
		KeyNodes:BHRYZA8eSgJCbo6zUoPvEQniouvzgAtQSnY,BHS9pd1gQhKZiyum8V7QQJganhWBTuxT6WP,BHXAPyLs9Mmvs9QnDfskGyfPdLEcBpK87Jn,BHhazFrZfiNkYdpPMakxU1d3DC9nkBGfnF1,

$ docker-compose run bhcli query cu asset BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL BHETH --chain-id bhchain-testnet

  CUAddress:BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL
  Symbol:BHETH
  Address:0x2a061581Ae905F5223E21028C9b738759fa721db
  Balance:0
  BalanceOnhold:0
  AssetType:2

```
In a short description, we can query the KeyGen order with order id ```0``` to get the deposit address ```0x2a061581Ae905F5223E21028C9b738759fa721db``` from ```MultiSignAddress```, or query the asset ```BHETH``` to get it from ```Address```. The asset symbol is ```BHETH```, meaning ethers in Ethereum, currently using Ropsten testnet.

**Note:** In demo chain, we only support asset symbol BHETH, and other symbols will be failed. Also an custodian unit can create at most 1 deposit address.

### 3. Deposit cross-chain assets

With the created custodian deposit address, we can deposit Ropsten ethers to the custodian unit. First we send some ethers to the ETH address ```0x2a061581Ae905F5223E21028C9b738759fa721db``` on Ropsten testnet. This can be done by MetaMask or other Ethereum wallets.

Here we finish a Ropsten TestNet transaction and deposit 0.00015 ether at https://ropsten.etherscan.io/tx/0xc3bdb9b26add5008e3c2917c136b734d80f7b10be204757fc8e7429359c8d56a

With the information provided on etherscan, we run the deposit command in Bluehelix Chain testnet as follows:

```console
$ docker-compose run bhcli --chain-id bhchain-testnet tx asset deposit 150ubheth 6630534 0x2a061581Ae905F5223E21028C9b738759fa721db 0xc3bdb9b26add5008e3c2917c136b734d80f7b10be204757fc8e7429359c8d56a --from alice
{"chain_id":"bhchain-testnet","account_number":"0","sequence":"1","fee":{"amount":[{"denom":"bht","amount":"200000000000000000"}],"gas":"200000"},"msgs":[{"type":"asset/MsgDeposit","value":{"from":"BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL","ext_address":"0x2a061581Ae905F5223E21028C9b738759fa721db","coins":[{"denom":"bheth","amount":"150000000000000"}],"utxo_ins":null,"txhash":"0xc3bdb9b26add5008e3c2917c136b734d80f7b10be204757fc8e7429359c8d56a","external_block_height":"6630534"}}],"memo":""}

confirm transaction before signing and broadcasting [Y/n]: Y
Password to sign with 'alice':

Response:
  TxHash: 787B33016F7E6473894FF3F08191BE9103D6C52279A8333C7D94B2B32BB6A69D
```

After the above command is finished, we can check the BHETH balance changed to 0.00015 ubheth by running:

```console
$ docker-compose run bhcli query cu asset BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL BHETH --chain-id bhchain-testnet

  CUAddress:BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL
  Symbol:BHETH
  Address:0x2a061581Ae905F5223E21028C9b738759fa721db
  Balance:150000000000000
  BalanceOnhold:0
  AssetType:2

```

### 4. Collect cross-chain assets to token withdrawal address

Before we can transfer assets on Bluehelix Chain Demo, we must collect the cross-chain assets to the withdrawal address of the asset token, i.e., ```BHETH`` which is the only supported cross-chain asset currently.

For better performance, an asset token can have multiple withdrawal addresses. We can find all addresses by running

```console
$  docker-compose run bhcli query token token BHETH  --chain-id bhchain-testnet

	Issuer:
	MainnetToken:
	TokenType:2
	IsSendEnabled:true
	IsDepositEnabled:true
	IsWithdrawalEnabled:true
	Decimals:18
	TotalSupply:0
	CollectThreshold:100000000000000
	OpenFee:1000000000000000000
	SysOpenFee:10000000000000000000
	WithdrawalFee:0
	WithdrawalAddresses:0x4DE507Cd351E2669480C27cd48e254F542d9a07E,0x81279dED7A37D855b9801B506e9e2FbD8c9C3d95,0xA3F9F77eD66FA591E4208fd4AC21Ef60945252b6,0xF3610994d9F9A928C70e8361d56335EF7C726639,0xbFC2f0C3f0FC237b3a26d24f84a8c0CbD4693CA2,0xcdC8fbAa7AeD3AaE469281aC60fBE7c83d388300
	DepositAddresses:

```

Here we use address type ```3``` meaning querying for withdrawal addresses. We pick one of ETH addresses on Ropsten Testnet is ```0x4DE507Cd351E2669480C27cd48e254F542d9a07E```. So we can start collecting 0.00012895 ether out of 0.000150 ether of our custodian unit, by paying maximally 21050 gas unit times 1 gwei gas price as cross-chain gas fee.

```console
$  docker-compose run bhcli --chain-id bhchain-testnet tx asset collect-start 128950nbheth 6630535 21050 1000000000 BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL 0x2a061581Ae905F5223E21028C9b738759fa721db 0x4DE507Cd351E2669480C27cd48e254F542d9a07E --from alice
{"chain_id":"bhchain-testnet","account_number":"0","sequence":"2","fee":{"amount":[{"denom":"bht","amount":"200000000000000000"}],"gas":"200000"},"msgs":[{"type":"asset/MsgCollectSign","value":{"from":"BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL","collect_from":"BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL","collect_from_address":"0x2a061581Ae905F5223E21028C9b738759fa721db","collect_to_address":"0x4DE507Cd351E2669480C27cd48e254F542d9a07E","symbol":"BHETH","amount":"128950000000000","utxo_ins":null,"utxo_outs":null,"gas_unit":"21050","gas_price":"1000000000","external_block_number":"6630535"}}],"memo":""}

confirm transaction before signing and broadcasting [Y/n]: Y
Password to sign with 'alice':

Response:
  TxHash: 2F22B5D15622F23D904A873F6F9D11DB2032E2C8CBED3E2EEDABB1D79D5CD644
```

*Note*: The external_block_number argument we use ```6630535```, which is the block height in ETH Ropsten testnet, higher than ```6630534``` used in deposit transaction. In fact any value higher than ```6630534``` can be used, before we actually running the collect transaction.

Since the private key shares for cross-chain deposit address ```0x2a061581Ae905F5223E21028C9b738759fa721db``` are managed by all validators, the validators will go through a multi signature process to generate the signature for the eth transaction to transfer 0.00012895 ether from ```0x2a061581Ae905F5223E21028C9b738759fa721db``` to ```0x4DE507Cd351E2669480C27cd48e254F542d9a07E```. After the signature is generated, the order will contain the signed transaction data, obtained in ```SignedTx``` field by querying order id ```1```:

```console
$ docker-compose run bhcli query cu order BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL 0 --chain-id bhchain-testnet

		CUAddress:BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL
		ID:1
		OrderType:3
		Symbol:BHETH
		Status:6
		AssetAmount:128950000000000
		CollectFrom:BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL
		From:0x2a061581Ae905F5223E21028C9b738759fa721db
		To:0x4DE507Cd351E2669480C27cd48e254F542d9a07E
		ExternalBlockNumber:6630535
		SignedTx:F86980843B9ACA0082523A944DE507CD351E2669480C27CD48E254F542D9A07E86754782F19C008029A0036AB79EEE1C14ED8C87D9F9E2B1327233299F479DEFCFAEDDCF4FCB49385E80A03E045A19368553F8FDFC3E17A3A1C80AB48A6792936C6217BF4BB7F716226EC3

```

We can broadcast the signed transaction hex using any tool, for example, https://ropsten.etherscan.io/pushTx. In this example, the result is at https://ropsten.etherscan.io/tx/0x281ac9bf6d4d98854788517aec8c74789117bc160b07a1b9ef8a500b9619bb31. Given the information, we finish the collect by running:

```console
$ docker-compose run bhcli --chain-id bhchain-testnet tx asset collect-finish 1 21000000000000 6630544 0x281ac9bf6d4d98854788517aec8c74789117bc160b07a1b9ef8a500b9619bb31 --from alice
{"chain_id":"bhchain-testnet","account_number":"0","sequence":"3","fee":{"amount":[{"denom":"bht","amount":"200000000000000000"}],"gas":"200000"},"msgs":[{"type":"asset/MsgCollect","value":{"from":"BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL","order_id":"1","gas_used":"21000000000000","external_block_number":"6630544","tx_hash":"0x281ac9bf6d4d98854788517aec8c74789117bc160b07a1b9ef8a500b9619bb31"}}],"memo":""}

confirm transaction before signing and broadcasting [Y/n]: Y
Password to sign with 'user115':12345678

Response:
  TxHash: B4A4DC1B88DD7ED49D8D7970DBDB2014071E91BBEA28BDD847FBE22E603D9613
$ docker-compose run bhcli query cu asset BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL BHETH --chain-id bhchain-testnet

  CUAddress:BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL
  Symbol:BHETH
  Address:0x2a061581Ae905F5223E21028C9b738759fa721db
  Balance:129000000000000
  BalanceOnhold:0
  AssetType:2

```

Then we note that after the collect, the BHETH balance is unchanged except the actual cross-chain gas fee paid to the ETH Ropsten testnet (21000 gwei = 0.000150 bheth - 0.000129 bheth).

### 5. Transfer cross-chain assets and then withdraw from token withdrawal address

After collect, we can transfer cross-chain assets on Bluehelix Chain testnet, and a custodian unit, for example, ```bob``` at ```BHi7TBosMNoAtpH4FQZPYJJ71XAogwSYbNm```, even though it have not deposited any cross-chain assets, can withdraw received assets from one of the token withdrawal addresses.

First, we transfer 0.000129 ether to another account.

```console
$ docker-compose run bhcli --chain-id bhchain-testnet tx send BHi7TBosMNoAtpH4FQZPYJJ71XAogwSYbNm 129000nbheth --from alice --gas-prices 1ubht
{"chain_id":"bhchain-testnet","account_number":"0","sequence":"4","fee":{"amount":[{"denom":"bht","amount":"200000000000000000"}],"gas":"200000"},"msgs":[{"type":"transfer/MsgTransfer","value":{"from_address":"BHZVBveATBY9nFMLUg3bYfqyKDUYLBhQjdL","to_address":"BHi7TBosMNoAtpH4FQZPYJJ71XAogwSYbNm","amount":[{"denom":"bheth","amount":"129000000000000"}]}}],"memo":""}

confirm transaction before signing and broadcasting [Y/n]: Y
Password to sign with 'alice':

Response:
  TxHash: C2572D6BEA67FA666457242460F440EE748E9A2FE43A2B37FFD4B8C0C2CE2D3D
```

```0x4DE507Cd351E2669480C27cd48e254F542d9a07E```, one of the token withdrawal addresses we picked above, to ```0x11f6fA43465f83E08531B3F4f0043F8075B25b3f```, by paying maximally 21050 gas unit times 1 gwei gas price as cross-chain gas fee. Of course, before that, this custodian unit should have some BHT for gas fee on Bluehelix Chain, using command similar to above but with different asset denom ```bht```.

```console
$ docker-compose run bhcli --chain-id bhchain-testnet tx asset withdrawal-start 107900nbheth 6630545 21050 1000000000 0x4DE507Cd351E2669480C27cd48e254F542d9a07E 0x11f6fA43465f83E08531B3F4f0043F8075B25b3f --from bob --gas-prices 1ubht
{"chain_id":"bhchain-testnet","account_number":"0","sequence":"0","fee":{"amount":[{"denom":"bht","amount":"200000000000000000"}],"gas":"200000"},"msgs":[{"type":"asset/MsgWithdrawalSign","value":{"from":"BHi7TBosMNoAtpH4FQZPYJJ71XAogwSYbNm","withdrawal_from_address":"0x4DE507Cd351E2669480C27cd48e254F542d9a07E","withdrawal_to_address":"0x11f6fA43465f83E08531B3F4f0043F8075B25b3f","symbol":"BHETH","amount":"107900000000000","utxo_ins":null,"utxo_outs":null,"gas_unit":"21050","gas_price":"1000000000","external_block_number":"6630545"}}],"memo":""}

confirm transaction before signing and broadcasting [Y/n]: Y
Password to sign with 'bob':

Response:
  TxHash: 678F3EC9D1DC7787F13ADA42EA06E98D2BD78E5678628E4FEEEFEAB6539F4F68
```

*Note*: The external_block_number argument we use ```6630545```, which is the block height in ETH Ropsten testnet, higher than ```6630544``` used in collect-finish transaction. In fact any value higher than ```6630545``` can be used, before we actually running the withdrawal transaction.

Since the private key shares for cross-chain token withdrawal address ```0x4DE507Cd351E2669480C27cd48e254F542d9a07E``` are managed by all validators, the validators will go through a multi signature process to generate the signature for the eth transaction to withdraw 0.0001 ether. After the signature is generated, the order will contain the signed transaction data, obtained in ```SignedTx``` field by querying order id ```2```:

```console
$ docker-compose run bhcli query cu order BHi7TBosMNoAtpH4FQZPYJJ71XAogwSYbNm 0 --chain-id bhchain-testnet

		CUAddress:BHi7TBosMNoAtpH4FQZPYJJ71XAogwSYbNm
		ID:0
		OrderType:2
		Symbol:BHETH
		Status:6
		AssetAmount:107900000000000
		From:0x4DE507Cd351E2669480C27cd48e254F542d9a07E
		To:0x11f6fA43465f83E08531B3F4f0043F8075B25b3f
		ExternalBlockNumber:6630545
		SignedTx:F86980843B9ACA0082523A9411F6FA43465F83E08531B3F4F0043F8075B25B3F8662226D2BD800802AA0B398AE2342185A5F80207435FD49C88FC12665D4C2302A413106AAF14ABDF343A04DFC0EE77D8BC9C241057592C033447B34E316B243C363E6DD1F5CDEA765E891
```

We can broadcast the signed transaction hex using any tool, for example, https://ropsten.etherscan.io/pushTx. In this example, the result is at https://ropsten.etherscan.io/tx/0x994810e6c24d87a614698f582c6d0b9d11150c7084c3f9b8db617487738c7416. Given the information, we finish the collect by running:

```console
$ docker-compose run bhcli --chain-id bhchain-testnet tx asset withdrawal-finish 0 21000000000000 6630555 0x994810e6c24d87a614698f582c6d0b9d11150c7084c3f9b8db617487738c7416 --from bob
{"chain_id":"bhchain-testnet","account_number":"0","sequence":"1","fee":{"amount":[{"denom":"bht","amount":"200000000000000000"}],"gas":"200000"},"msgs":[{"type":"asset/MsgWithdrawal","value":{"from":"BHi7TBosMNoAtpH4FQZPYJJ71XAogwSYbNm","order_id":"0","gas_used":"21000000000000","external_block_number":"6630555","tx_hash":"0x994810e6c24d87a614698f582c6d0b9d11150c7084c3f9b8db617487738c7416"}}],"memo":""}

confirm transaction before signing and broadcasting [Y/n]: Y
Password to sign with 'bob':

Response:
  TxHash: 83752AE5C8D1E9FB7CF2ACB3F7412DB266281931612B93556A005E01FAF5EFBF

$ docker-compose run bhcli query cu asset BHWHE2muYTvDj8dDGz4P5wnwB6uyL39W2Vd BHETH --chain-id bhchain-testnet

  CUAddress:BHi7TBosMNoAtpH4FQZPYJJ71XAogwSYbNm
  Symbol:BHETH
  Address:
  Balance:100000000000
  BalanceOnhold:0
  AssetType:2

```

The left BHT balance is only 100nbht, which shows that the withdrawal is successfully recorded on Bluehelix Chain testnet ledger.

## Notes

We acknowledge that on Bluehelix Chain testnet the features are not completed and the network may not be stable. Here are part of known issues:

- Only support Ethereum Ropsten Testnet via asset symbol BHETH. Others are not yet supported and will be lost in depositing to Bluehelix Chain testnet.

- There is gas fee, with default gas price 1ubht.

- The validators are pre-defined and may not be altered. Currently there are 4 validators.

- Currently, per each testnet ETH address, at most one transaction (deposit, collect, and withdrawal) can be proccessed in each ETH block. The block number should be supplied as a transaction parameter on Bluehelix Chain testnet, as shown above. Please allow some time for the cross-chain operation to be finished.

- The testnet may have frequent update, including API and cli tool changed, and even the whole network is reset. When a reset happens, all testnet ETH on chain may be lost if not withdraw in time.

- Currently, the architecture is based on [cosmos-sdk](https://github.com/cosmos/cosmos-sdk). We will open source the code once it becomes more stable.

If you find any other issues, feel free to report. Thanks.

Bluehelix Chain team
